---
# HTTPRoute for ArgoCD Server
# Accessible at https://holm.chat/argoCD/
# Note: ArgoCD must be configured with --insecure flag and server.rootpath=/argoCD
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: argocd-server
  namespace: argocd
spec:
  parentRefs:
    - name: main-gateway
      namespace: envoy-gateway-system
  rules:
    # API routes - highest priority
    - matches:
        - path:
            type: PathPrefix
            value: /argoCD/api
      backendRefs:
        - name: argocd-server
          port: 80
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Forwarded-Proto
                value: https
    # Static assets and extensions
    - matches:
        - path:
            type: PathPrefix
            value: /argoCD/assets
        - path:
            type: PathPrefix
            value: /argoCD/extensions
      backendRefs:
        - name: argocd-server
          port: 80
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Forwarded-Proto
                value: https
    # Main UI with SPA routing - rewrite to index
    - matches:
        - path:
            type: PathPrefix
            value: /argoCD
      backendRefs:
        - name: argocd-server
          port: 80
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Forwarded-Proto
                value: https
---
# HTTPRoute for assets accessed without /argoCD prefix
# Redirects to proper /argoCD path
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: argocd-assets-redirect
  namespace: argocd
spec:
  parentRefs:
    - name: main-gateway
      namespace: envoy-gateway-system
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /assets
        - path:
            type: PathPrefix
            value: /extensions
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /argoCD
      backendRefs:
        - name: argocd-server
          port: 80
