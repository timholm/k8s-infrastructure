---
# Traefik IngressRoute for ArgoCD Server
# Accessible at http://<node-ip>:30190/argoCD/
# Note: ArgoCD must be configured with --insecure flag and server.rootpath=/argoCD
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: argocd-server
  namespace: argocd
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - kind: Rule
      match: PathPrefix(`/argoCD/api`)
      middlewares:
        - name: argocd-headers
      priority: 100
      services:
        - name: argocd-server
          passHostHeader: true
          port: 80
    - kind: Rule
      match: PathPrefix(`/argoCD/assets`) || PathPrefix(`/argoCD/extensions`) || PathRegexp(`^/argoCD/.*\.js$`)
      middlewares:
        - name: argocd-headers
      priority: 90
      services:
        - name: argocd-server
          passHostHeader: true
          port: 80
    - kind: Rule
      match: PathPrefix(`/argoCD`)
      middlewares:
        - name: argocd-rewrite-index
        - name: argocd-headers
      priority: 10
      services:
        - name: argocd-server
          passHostHeader: true
          port: 80
---
# IngressRoute for static assets accessed without /argoCD prefix
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: argocd-assets
  namespace: argocd
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - kind: Rule
      match: PathPrefix(`/assets`) || PathPrefix(`/extensions`) || PathPrefix(`/api`) || Path(`/main.adc90b92a52595324894.js`) || Path(`/extensions.js`)
      middlewares:
        - name: argocd-addprefix
        - name: argocd-headers
      services:
        - name: argocd-server
          passHostHeader: true
          port: 80
---
# Add /argoCD prefix for assets accessed without prefix
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: argocd-addprefix
  namespace: argocd
spec:
  addPrefix:
    prefix: /argoCD
---
# Set X-Forwarded-Proto header
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: argocd-headers
  namespace: argocd
spec:
  headers:
    customRequestHeaders:
      X-Forwarded-Proto: https
---
# Rewrite path regex for SPA routing
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: argocd-rewrite
  namespace: argocd
spec:
  replacePathRegex:
    regex: ^/argoCD/(?!api|assets|extensions|main\.).*
    replacement: /argoCD/
---
# Rewrite index path for SPA
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: argocd-rewrite-index
  namespace: argocd
spec:
  replacePath:
    path: /argoCD/
---
# Strip /argoCD prefix (for reference, not currently used in routes)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: argocd-stripprefix
  namespace: argocd
spec:
  stripPrefix:
    prefixes:
      - /argoCD
